# Milestone v1.1: Map Overhaul

**Status:** SHIPPED 2026-01-19
**Phases:** 1-4
**Total Plans:** 7

## Overview

This milestone replaced the current Leaflet-based map with MapLibre GL JS to unlock WebGL-accelerated vector tile rendering, native clustering, and smoother mobile interactions. The migration proceeded in layers: foundation work established the new map library, followed by clustering for performance, then bidirectional search-map integration that unifies the previously siloed map and search experiences.

## Phases

### Phase 1: MapLibre Foundation

**Goal**: Users see businesses on a WebGL-accelerated map with their current location indicated
**Depends on**: Nothing (first phase)
**Requirements**: MAP-01, MAP-05
**Plans**: 3 plans

Plans:
- [x] 01-01-PLAN.md — Install MapLibre, create MapLibreMap component with markers and popups
- [x] 01-02-PLAN.md — Add user location marker, geolocation, and distance display
- [x] 01-03-PLAN.md — Add map view to search page (gap closure)

**Key Files**:
- `components/map/MapLibreMap.tsx` (new, replaces LeafletMap.tsx)
- `components/map/UserLocationMarker.tsx` (new)
- `app/search/page.tsx` (add map view)
- CSS imports for maplibre-gl

---

### Phase 2: Clustering

**Goal**: Map performs smoothly with 50+ businesses by clustering nearby markers
**Depends on**: Phase 1
**Requirements**: MAP-02
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md — Native MapLibre clustering implementation with Source/Layer architecture

**Key Files**:
- `components/map/MapLibreMap.tsx` (extend with clustering)
- `components/map/clusterLayers.ts` (new, layer style definitions)

---

### Phase 3: Search-to-Map Sync

**Goal**: Search filters and results automatically update the map view
**Depends on**: Phase 2
**Requirements**: MAP-03, MAP-06, API-01, ARCH-01
**Plans**: 2 plans

Plans:
- [x] 03-01-PLAN.md — API bounds extension and useMapSearch hook
- [x] 03-02-PLAN.md — Search page map integration and view toggles

**Key Files**:
- `hooks/useMapSearch.ts` (new, central state management)
- `app/api/businesses/route.ts` (extend with bounds params)
- `components/search/ViewToggle.tsx` (new, view mode toggle)
- `app/search/page.tsx` (refactor to use hook, add view toggles)

---

### Phase 4: Map-to-Search Sync

**Goal**: Users can explore the map and search the visible area
**Depends on**: Phase 3
**Requirements**: MAP-04
**Plans**: 1 plan

Plans:
- [x] 04-01-PLAN.md — Bidirectional sync with Search this area button

**Key Files**:
- `hooks/useMapSearch.ts` (extend for bidirectional sync)
- `components/map/SearchThisAreaButton.tsx` (new)
- `components/map/MapLibreMap.tsx` (add onMoveEnd tracking)
- `app/search/page.tsx` (stale state visual feedback)

---

## Milestone Summary

**Key Decisions:**
- Used react-map-gl/maplibre wrapper for React integration
- MapTiler free tier (100K loads/month) for vector tiles
- Native MapLibre clustering instead of use-supercluster library
- isProgrammaticMove ref pattern for infinite loop prevention
- URL as single source of truth for all filter state

**Issues Resolved:**
- Leaflet DOM-based markers slow with many businesses → MapLibre WebGL layer-based rendering
- No clustering → Native GeoJSON clustering with color-coded counts
- Siloed map and search → Bidirectional sync via useMapSearch hook

**Issues Deferred:**
- MAP-08: Mobile-optimized gestures (deferred to v1.2)
- CLEAN-01: Leaflet package removal (deferred to v1.2)
- Hover state styling (requires Layer-based approach, deferred to v1.2)

**Technical Debt Incurred:**
- Leaflet packages still in bundle (to be removed in v1.2)

---

*For current project status, see .planning/ROADMAP.md*

---
*Archived: 2026-01-19*
