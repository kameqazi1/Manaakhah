---
phase: 01-booking-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - components/booking/DatePicker.tsx
  - lib/availability.ts
autonomous: true

must_haves:
  truths:
    - "Calendar component renders and allows date selection"
    - "Time slot generation produces correct slots based on availability"
    - "Unavailable days are disabled in calendar"
  artifacts:
    - path: "components/booking/DatePicker.tsx"
      provides: "Calendar UI component for date selection"
      min_lines: 50
    - path: "lib/availability.ts"
      provides: "Time slot generation utilities"
      exports: ["generateTimeSlots", "TimeSlot"]
  key_links:
    - from: "DatePicker"
      to: "react-day-picker"
      via: "import DayPicker"
      pattern: "import.*DayPicker.*from.*react-day-picker"
    - from: "generateTimeSlots"
      to: "date-fns"
      via: "date manipulation"
      pattern: "import.*from.*date-fns"
---

<objective>
Install react-day-picker calendar library and create the foundational booking UI components and utilities.

Purpose: The booking page needs a visual calendar for date selection and logic to generate available time slots. These are independent of the database models and can be built in parallel.

Output: DatePicker component, time slot generation utility, and installed dependencies.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-booking-foundation/01-RESEARCH.md

# Existing patterns
@components/ui/button.tsx
@components/ui/card.tsx
@lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-day-picker and create DatePicker component</name>
  <files>package.json, components/booking/DatePicker.tsx</files>
  <action>
1. Install react-day-picker:
   ```bash
   npm install react-day-picker@^9.4.0
   ```

2. Create `components/booking/DatePicker.tsx`:

```typescript
"use client";

import { DayPicker } from "react-day-picker";
import { format, isBefore, startOfDay } from "date-fns";
import { cn } from "@/lib/utils";
import "react-day-picker/style.css";

interface DatePickerProps {
  selected?: Date;
  onSelect: (date: Date | undefined) => void;
  disabledDates?: Date[];
  availableDays?: number[]; // 0-6 for days of week with availability
  minDate?: Date;
  className?: string;
}

export function DatePicker({
  selected,
  onSelect,
  disabledDates = [],
  availableDays,
  minDate,
  className,
}: DatePickerProps) {
  const today = startOfDay(new Date());
  const effectiveMinDate = minDate || today;

  const disableMatcher = (date: Date) => {
    // Disable past dates
    if (isBefore(date, effectiveMinDate)) {
      return true;
    }

    // Disable days not in business availability
    if (availableDays && availableDays.length > 0 && !availableDays.includes(date.getDay())) {
      return true;
    }

    // Disable specific dates (exceptions, holidays)
    if (disabledDates.some((d) => format(d, "yyyy-MM-dd") === format(date, "yyyy-MM-dd"))) {
      return true;
    }

    return false;
  };

  return (
    <div className={cn("p-3 bg-white rounded-lg border", className)}>
      <DayPicker
        mode="single"
        selected={selected}
        onSelect={onSelect}
        disabled={disableMatcher}
        showOutsideDays={false}
        className="rdp-custom"
        classNames={{
          months: "flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",
          month: "space-y-4",
          caption: "flex justify-center pt-1 relative items-center",
          caption_label: "text-sm font-medium",
          nav: "space-x-1 flex items-center",
          nav_button: cn(
            "h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 inline-flex items-center justify-center rounded-md border border-input hover:bg-accent"
          ),
          table: "w-full border-collapse space-y-1",
          head_row: "flex",
          head_cell: "text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",
          row: "flex w-full mt-2",
          cell: "h-9 w-9 text-center text-sm p-0 relative",
          day: cn(
            "h-9 w-9 p-0 font-normal rounded-md",
            "hover:bg-accent hover:text-accent-foreground",
            "focus:bg-accent focus:text-accent-foreground focus:outline-none"
          ),
          day_selected: "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground",
          day_disabled: "text-muted-foreground opacity-50 cursor-not-allowed",
          day_outside: "text-muted-foreground opacity-50",
          day_today: "bg-accent text-accent-foreground font-semibold",
        }}
      />
    </div>
  );
}
```

Note: The component uses react-day-picker v9 API. It accepts:
- `selected`: Currently selected date
- `onSelect`: Callback when date is selected
- `disabledDates`: Specific dates to disable (holidays, exceptions)
- `availableDays`: Array of day numbers (0-6) when business is open
- `minDate`: Earliest selectable date (defaults to today)
  </action>
  <verify>Run `npm run build` - should compile without TypeScript errors. Check that react-day-picker is in package.json dependencies.</verify>
  <done>DatePicker component exists and compiles, react-day-picker is installed</done>
</task>

<task type="auto">
  <name>Task 2: Create time slot generation utility</name>
  <files>lib/availability.ts</files>
  <action>
Create `lib/availability.ts` with time slot generation logic:

```typescript
import { addMinutes, format, parse, isBefore, isAfter, isEqual } from "date-fns";

export interface TimeSlot {
  time: string; // "09:00" format
  available: boolean;
  reason?: string; // "Already booked", "Outside hours", etc.
}

export interface BusinessAvailabilityData {
  startTime: string; // "09:00"
  endTime: string; // "17:00"
  slotDuration: number; // in minutes
  bufferTime: number; // buffer between appointments in minutes
  isAvailable: boolean;
}

export interface ExistingBooking {
  appointmentTime: string; // "09:00"
  duration: number; // in minutes
}

/**
 * Generate available time slots for a given date based on business availability
 * and existing bookings.
 */
export function generateTimeSlots(
  availability: BusinessAvailabilityData,
  existingBookings: ExistingBooking[],
  date: Date,
  serviceDuration: number
): TimeSlot[] {
  if (!availability.isAvailable) {
    return [];
  }

  const slots: TimeSlot[] = [];
  const slotInterval = availability.slotDuration || serviceDuration;
  const buffer = availability.bufferTime || 0;

  // Parse start and end times
  let current = parse(availability.startTime, "HH:mm", date);
  const end = parse(availability.endTime, "HH:mm", date);

  // Generate slots
  while (isBefore(current, end)) {
    const timeStr = format(current, "HH:mm");
    const slotEnd = addMinutes(current, serviceDuration);

    // Check if slot extends beyond business hours
    if (isAfter(slotEnd, end)) {
      break;
    }

    // Check if slot overlaps with any existing booking
    const conflictingBooking = existingBookings.find((booking) => {
      const bookingStart = parse(booking.appointmentTime, "HH:mm", date);
      const bookingEnd = addMinutes(bookingStart, booking.duration);

      // Add buffer to booking end
      const bookingEndWithBuffer = addMinutes(bookingEnd, buffer);

      // Check for overlap: slot starts before booking ends AND slot ends after booking starts
      const slotStartsBeforeBookingEnds = isBefore(current, bookingEndWithBuffer) || isEqual(current, bookingEndWithBuffer);
      const slotEndsAfterBookingStarts = isAfter(slotEnd, bookingStart) || isEqual(slotEnd, bookingStart);

      // Overlap exists if both conditions are true
      return isBefore(current, bookingEndWithBuffer) && isAfter(slotEnd, bookingStart);
    });

    slots.push({
      time: timeStr,
      available: !conflictingBooking,
      reason: conflictingBooking ? "Already booked" : undefined,
    });

    // Move to next slot
    current = addMinutes(current, slotInterval);
  }

  return slots;
}

/**
 * Format time for display (12-hour format)
 */
export function formatTimeDisplay(time: string): string {
  const [hours, minutes] = time.split(":").map(Number);
  const period = hours >= 12 ? "PM" : "AM";
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, "0")} ${period}`;
}

/**
 * Check if a date is a valid booking date (not in the past, not too far in future)
 */
export function isValidBookingDate(date: Date, maxDaysAhead: number = 90): boolean {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const maxDate = new Date();
  maxDate.setDate(maxDate.getDate() + maxDaysAhead);
  maxDate.setHours(23, 59, 59, 999);

  return date >= today && date <= maxDate;
}
```

This utility:
- Generates time slots based on BusinessAvailability data
- Considers existing bookings to mark slots as unavailable
- Handles buffer time between appointments
- Provides helper functions for time formatting and date validation
  </action>
  <verify>Run `npx tsc --noEmit` to check for TypeScript errors. The file should compile cleanly.</verify>
  <done>lib/availability.ts exists with generateTimeSlots, formatTimeDisplay, and isValidBookingDate functions exported</done>
</task>

</tasks>

<verification>
- [ ] `npm install` completes without errors
- [ ] react-day-picker appears in package.json dependencies
- [ ] `npm run build` completes without TypeScript errors
- [ ] components/booking/DatePicker.tsx exists
- [ ] lib/availability.ts exists with exported functions
</verification>

<success_criteria>
- react-day-picker ^9.4.0 installed
- DatePicker component accepts selected, onSelect, disabledDates, availableDays props
- generateTimeSlots function correctly generates slots and marks booked times as unavailable
- formatTimeDisplay converts 24h to 12h format
- All code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-booking-foundation/01-02-SUMMARY.md`
</output>
