---
phase: 01-maplibre-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - .env.local
  - .env.example
  - components/map/MapLibreMap.tsx
  - components/map/BusinessMap.tsx
autonomous: true

must_haves:
  truths:
    - "Map renders with MapTiler vector tiles on homepage"
    - "Business markers display at correct coordinates"
    - "Markers show category-specific colors and icons"
    - "Clicking a marker shows business details popup"
    - "Popup 'View Details' link navigates to business page"
    - "SSR works without hydration errors"
  artifacts:
    - path: "components/map/MapLibreMap.tsx"
      provides: "MapLibre GL JS map component with markers and popups"
      min_lines: 150
    - path: "components/map/BusinessMap.tsx"
      provides: "Updated wrapper with MapLibreMap dynamic import"
      contains: "MapLibreMap"
  key_links:
    - from: "components/map/MapLibreMap.tsx"
      to: "maplibre-gl"
      via: "react-map-gl/maplibre import"
      pattern: "from 'react-map-gl/maplibre'"
    - from: "components/map/BusinessMap.tsx"
      to: "components/map/MapLibreMap.tsx"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*MapLibreMap.*ssr.*false"
    - from: "components/map/MapLibreMap.tsx"
      to: "MapTiler API"
      via: "NEXT_PUBLIC_MAPTILER_KEY env var"
      pattern: "NEXT_PUBLIC_MAPTILER_KEY"
---

<objective>
Replace Leaflet with MapLibre GL JS for WebGL-accelerated vector tile rendering.

Purpose: Establish the foundation for all subsequent map work. MapLibre provides GPU-accelerated rendering, smoother interactions, and native clustering support that Leaflet lacks.

Output: Working MapLibreMap.tsx component that renders businesses on a MapTiler-powered map with the same visual behavior as the current LeafletMap.tsx (markers with category colors/icons, popups with business details).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/research/PITFALLS.md

@components/map/LeafletMap.tsx
@components/map/BusinessMap.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MapLibre dependencies and configure environment</name>
  <files>
    - package.json
    - package-lock.json
    - .env.local
    - .env.example
  </files>
  <action>
Install maplibre-gl and react-map-gl:

```bash
npm install maplibre-gl react-map-gl
```

Add MapTiler API key to environment:

1. Create `.env.local` if it doesn't exist
2. Add: `NEXT_PUBLIC_MAPTILER_KEY=get_free_key_from_maptiler.com`
3. Update `.env.example` with the same variable (placeholder value)

Note: The user will need to get their own MapTiler API key from https://cloud.maptiler.com/account/keys/ - the free tier provides 100K map loads/month which is sufficient for development and early production.

Do NOT remove Leaflet packages yet - they will be removed in Phase 6 after full migration is tested.
  </action>
  <verify>
```bash
npm ls maplibre-gl react-map-gl
grep NEXT_PUBLIC_MAPTILER_KEY .env.example
```
Both packages installed, env var documented.
  </verify>
  <done>maplibre-gl and react-map-gl in package.json, NEXT_PUBLIC_MAPTILER_KEY in .env.example</done>
</task>

<task type="auto">
  <name>Task 2: Create MapLibreMap.tsx component with business markers</name>
  <files>
    - components/map/MapLibreMap.tsx
  </files>
  <action>
Create new MapLibreMap.tsx that replicates LeafletMap.tsx functionality using react-map-gl with MapLibre:

**Required imports:**
```typescript
'use client';
import { useRef, useState, useCallback, useEffect } from 'react';
import Map, { Marker, Popup, NavigationControl, MapRef } from 'react-map-gl/maplibre';
import 'maplibre-gl/dist/maplibre-gl.css';
```

**Interface** - Keep same Business interface as LeafletMap.tsx (id, name, category, address, city, latitude, longitude, averageRating, reviewCount, distance?, tags?, imageUrl?, description?)

**Props interface** - Same as LeafletMap: businesses, userLat, userLng, radius

**Component structure:**
1. MapRef for programmatic control
2. State for selectedBusiness (for popup), hoveredBusiness (for tooltip effect)
3. Import CATEGORIES and BUSINESS_TAGS from BusinessMap.tsx (same pattern as LeafletMap)

**Map configuration:**
```typescript
<Map
  ref={mapRef}
  initialViewState={{
    latitude: userLat,
    longitude: userLng,
    zoom: 13
  }}
  style={{ width: '100%', height: '600px' }}
  mapStyle={`https://api.maptiler.com/maps/streets-v2/style.json?key=${process.env.NEXT_PUBLIC_MAPTILER_KEY}`}
>
```

**Business markers:**
- Use react-map-gl `<Marker>` component for each business
- Create custom marker element matching current design: 44x44px colored circle with emoji icon
- Colors from CATEGORIES array (same as current)
- Add onClick handler to set selectedBusiness
- Add onMouseEnter/onMouseLeave for hover effect (scale transform)

**Popup:**
- Use react-map-gl `<Popup>` component when selectedBusiness is set
- Port the createPopupContent logic from LeafletMap but render as JSX (not HTML string)
- Include: image or gradient placeholder, business name, category icon, rating, tags, address, distance, "View Details" button
- Use Next.js Link component for "View Details" button (not raw anchor) for client-side navigation
- Close popup on click outside or X button

**Fit bounds on business change:**
- useEffect that runs when businesses array changes
- Calculate bounds from all business coordinates
- Call mapRef.current?.fitBounds() with padding

**User location marker:**
- Render blue pulsing dot at userLat/userLng position
- Use CSS animation for pulse effect (same keyframes as current)
- Add "Your Location" label on hover

**Radius circle:**
- For now, skip the radius circle visualization (it requires turf.js or custom GeoJSON)
- This is acceptable because Phase 2 will add proper clustering which makes radius less important

**Selected business detail card:**
- Keep the same Card component below the map showing selected business details
- Same layout as current LeafletMap.tsx

**Styling:**
- Use Tailwind classes matching current design
- Popup styling via className props on Popup component
- Marker hover effect via inline styles or Tailwind hover: classes
  </action>
  <verify>
```bash
# Check file exists with expected structure
grep -q "from 'react-map-gl/maplibre'" components/map/MapLibreMap.tsx && echo "MapLibre import OK"
grep -q "NEXT_PUBLIC_MAPTILER_KEY" components/map/MapLibreMap.tsx && echo "Env var OK"
grep -q "Marker" components/map/MapLibreMap.tsx && echo "Marker component OK"
grep -q "Popup" components/map/MapLibreMap.tsx && echo "Popup component OK"
```
  </verify>
  <done>MapLibreMap.tsx exists with Map, Marker, Popup components rendering businesses with category styling</done>
</task>

<task type="auto">
  <name>Task 3: Update BusinessMap.tsx to use MapLibreMap and verify rendering</name>
  <files>
    - components/map/BusinessMap.tsx
  </files>
  <action>
Update BusinessMap.tsx to import MapLibreMap instead of LeafletMap:

1. Change the dynamic import:
```typescript
const MapLibreMap = dynamic(() => import('./MapLibreMap'), {
  ssr: false,
  loading: () => (
    <Card>
      <CardContent className="p-8 text-center h-[600px] flex items-center justify-center">
        <p>Loading map...</p>
      </CardContent>
    </Card>
  )
});
```

2. Update the JSX to render MapLibreMap instead of LeafletMap:
```typescript
<MapLibreMap
  businesses={filteredBusinesses}
  userLat={userLat}
  userLng={userLng}
  radius={radius}
/>
```

3. Keep all filter logic, CATEGORIES, and BUSINESS_TAGS exports unchanged (they're used by MapLibreMap)

**Verification steps after update:**
1. Run `npm run dev`
2. Open http://localhost:3000
3. Scroll to "Businesses Near You" section
4. Verify:
   - Map loads with MapTiler vector tiles (not CartoDB raster tiles)
   - Business markers appear with correct category colors and emoji icons
   - Clicking a marker opens popup with business details
   - "View Details" in popup navigates to /business/[id] without full page reload
   - No console errors about hydration mismatch
   - Filter controls still work (category and tag filtering)
  </action>
  <verify>
```bash
# Check dynamic import updated
grep -q "MapLibreMap" components/map/BusinessMap.tsx && echo "Import updated"
grep -q "ssr: false" components/map/BusinessMap.tsx && echo "SSR disabled"

# Run type check
npx tsc --noEmit 2>&1 | head -20
```

Manual verification: Open localhost:3000, map renders with vector tiles, markers clickable, popup shows details.
  </verify>
  <done>BusinessMap imports MapLibreMap, map renders on homepage with business markers and working popups</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
```bash
npm run build
```
Build should complete without errors (SSR handling correct).

2. **Runtime verification:**
- Homepage map renders with MapTiler vector tiles
- Markers display at correct locations with category colors
- Click marker -> popup appears with business info
- Click "View Details" -> navigates to business page
- Filter by category -> markers update
- No hydration mismatch errors in console

3. **Type safety:**
```bash
npx tsc --noEmit
```
No TypeScript errors.
</verification>

<success_criteria>
- [ ] maplibre-gl and react-map-gl installed
- [ ] NEXT_PUBLIC_MAPTILER_KEY in .env.example
- [ ] MapLibreMap.tsx renders map with MapTiler tiles
- [ ] Business markers show category colors and emoji icons
- [ ] Clicking marker shows popup with business details
- [ ] Popup "View Details" uses Next.js Link for client navigation
- [ ] User location marker visible with pulse animation
- [ ] npm run build succeeds without hydration errors
- [ ] Homepage map works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/01-maplibre-foundation/01-01-SUMMARY.md`
</output>
