---
phase: 01-maplibre-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - components/map/MapLibreMap.tsx
  - components/map/UserLocationMarker.tsx
autonomous: true

must_haves:
  truths:
    - "User sees their current location on the map as a distinct blue pulsing marker"
    - "User can click 'Center on my location' button to pan map to their position"
    - "Business markers/cards show distance from user location"
    - "Map gracefully handles geolocation permission denial"
  artifacts:
    - path: "components/map/UserLocationMarker.tsx"
      provides: "Pulsing blue user location marker component"
      min_lines: 30
    - path: "components/map/MapLibreMap.tsx"
      provides: "Map with geolocation integration and distance display"
      contains: "navigator.geolocation"
  key_links:
    - from: "components/map/MapLibreMap.tsx"
      to: "navigator.geolocation"
      via: "getCurrentPosition API call"
      pattern: "geolocation.getCurrentPosition"
    - from: "components/map/MapLibreMap.tsx"
      to: "components/map/UserLocationMarker.tsx"
      via: "component import and render"
      pattern: "UserLocationMarker"
---

<objective>
Add user location marker with geolocation request and distance display on business markers.

Purpose: Help users find businesses near them by showing their current position and how far each business is. This completes MAP-05 requirement.

Output: User sees a "You are here" marker at their location, business cards show "X miles away", and a button lets them center the map on their position.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/PITFALLS.md

@.planning/phases/01-maplibre-foundation/01-01-SUMMARY.md
@components/map/MapLibreMap.tsx
@components/map/BusinessMap.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserLocationMarker component with pulse animation</name>
  <files>
    - components/map/UserLocationMarker.tsx
  </files>
  <action>
Create a dedicated UserLocationMarker component that renders a pulsing blue dot:

```typescript
'use client';

import { Marker, Popup } from 'react-map-gl/maplibre';
import { useState } from 'react';

interface UserLocationMarkerProps {
  latitude: number;
  longitude: number;
}

export function UserLocationMarker({ latitude, longitude }: UserLocationMarkerProps) {
  const [showPopup, setShowPopup] = useState(false);

  return (
    <>
      <Marker
        latitude={latitude}
        longitude={longitude}
        anchor="center"
      >
        <div
          className="relative cursor-pointer"
          onClick={() => setShowPopup(!showPopup)}
          onMouseEnter={() => setShowPopup(true)}
          onMouseLeave={() => setShowPopup(false)}
        >
          {/* Pulse ring */}
          <div className="absolute inset-0 w-6 h-6 bg-blue-500 rounded-full opacity-30 animate-ping" />
          {/* Solid center dot */}
          <div className="relative w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow-lg"
               style={{ margin: '4px' }} />
        </div>
      </Marker>

      {showPopup && (
        <Popup
          latitude={latitude}
          longitude={longitude}
          anchor="bottom"
          offset={15}
          closeButton={false}
          closeOnClick={false}
        >
          <div className="px-2 py-1 text-sm font-medium">
            Your Location
          </div>
        </Popup>
      )}
    </>
  );
}
```

**Styling notes:**
- Use Tailwind's `animate-ping` for the pulse effect (built-in animation)
- Blue color (#3B82F6 / blue-500) matches the original LeafletMap design
- White border and shadow for visibility on any tile background
- Size: 16x16px center dot, 24x24px pulse ring

**Alternative CSS if animate-ping doesn't match desired effect:**
Add custom animation in the component or in globals.css:
```css
@keyframes location-pulse {
  0%, 100% {
    transform: scale(1);
    opacity: 0.3;
  }
  50% {
    transform: scale(1.5);
    opacity: 0.1;
  }
}
```
  </action>
  <verify>
```bash
# Check file exists with expected exports
grep -q "UserLocationMarker" components/map/UserLocationMarker.tsx && echo "Component exists"
grep -q "animate-ping\|location-pulse" components/map/UserLocationMarker.tsx && echo "Pulse animation present"
```
  </verify>
  <done>UserLocationMarker.tsx exports a component that renders a blue pulsing marker with hover popup</done>
</task>

<task type="auto">
  <name>Task 2: Add geolocation request and center button to MapLibreMap</name>
  <files>
    - components/map/MapLibreMap.tsx
  </files>
  <action>
Extend MapLibreMap.tsx with geolocation functionality:

**1. Add state for user location:**
```typescript
const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);
const [locationError, setLocationError] = useState<string | null>(null);
const [isLocating, setIsLocating] = useState(false);
```

**2. Create geolocation request function:**
```typescript
const requestUserLocation = useCallback(() => {
  if (!navigator.geolocation) {
    setLocationError('Geolocation not supported by your browser');
    return;
  }

  setIsLocating(true);
  setLocationError(null);

  navigator.geolocation.getCurrentPosition(
    (position) => {
      setUserLocation({
        lat: position.coords.latitude,
        lng: position.coords.longitude,
      });
      setIsLocating(false);
    },
    (error) => {
      setIsLocating(false);
      switch (error.code) {
        case error.PERMISSION_DENIED:
          setLocationError('Location permission denied');
          break;
        case error.POSITION_UNAVAILABLE:
          setLocationError('Location unavailable');
          break;
        case error.TIMEOUT:
          setLocationError('Location request timed out');
          break;
        default:
          setLocationError('Unable to get location');
      }
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 300000, // 5 min cache
    }
  );
}, []);
```

**3. Request location on mount (optional, or wait for user action):**
```typescript
useEffect(() => {
  // Request location automatically on mount
  // Or: remove this and only request when user clicks the button
  requestUserLocation();
}, [requestUserLocation]);
```

**4. Add "Center on my location" button:**
Add a button in the map controls area (top-right, below NavigationControl):
```typescript
<button
  onClick={() => {
    if (userLocation) {
      mapRef.current?.flyTo({
        center: [userLocation.lng, userLocation.lat],
        zoom: 14,
        duration: 1000,
      });
    } else {
      requestUserLocation();
    }
  }}
  disabled={isLocating}
  className="absolute top-24 right-2 z-10 bg-white p-2 rounded-lg shadow-md hover:bg-gray-50 disabled:opacity-50"
  title="Center on my location"
>
  {isLocating ? (
    <span className="w-5 h-5 block border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
  ) : (
    <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>
  )}
</button>
```

**5. Import and render UserLocationMarker:**
```typescript
import { UserLocationMarker } from './UserLocationMarker';

// In the Map JSX, render when location is available:
{userLocation && (
  <UserLocationMarker
    latitude={userLocation.lat}
    longitude={userLocation.lng}
  />
)}

// Also render at the fallback userLat/userLng props if no geolocation
// (the default Fremont coordinates from BusinessMap)
{!userLocation && (
  <UserLocationMarker
    latitude={userLat}
    longitude={userLng}
  />
)}
```

**6. Show location error as toast or inline message:**
If locationError is set, show a non-blocking message:
```typescript
{locationError && (
  <div className="absolute bottom-4 left-4 z-10 bg-yellow-50 border border-yellow-200 text-yellow-800 px-3 py-2 rounded-lg text-sm">
    {locationError}
  </div>
)}
```

**Note on prop userLat/userLng vs geolocation:**
- Props userLat/userLng are the default/fallback from BusinessMap
- If geolocation succeeds, userLocation state overrides for the marker position
- Business distance calculations should use userLocation if available, fallback to props
  </action>
  <verify>
```bash
grep -q "navigator.geolocation" components/map/MapLibreMap.tsx && echo "Geolocation API used"
grep -q "UserLocationMarker" components/map/MapLibreMap.tsx && echo "UserLocationMarker imported"
grep -q "flyTo\|easeTo" components/map/MapLibreMap.tsx && echo "Center animation present"
```

Manual: Open localhost:3000, browser should prompt for location permission. After allowing, blue marker appears at user position.
  </verify>
  <done>MapLibreMap requests geolocation, shows UserLocationMarker, and has "center on my location" button</done>
</task>

<task type="auto">
  <name>Task 3: Add distance display to business markers and popup</name>
  <files>
    - components/map/MapLibreMap.tsx
  </files>
  <action>
Add distance calculation and display:

**1. Add distance calculation helper function:**
```typescript
function calculateDistance(
  lat1: number,
  lng1: number,
  lat2: number,
  lng2: number
): number {
  // Haversine formula for distance in miles
  const R = 3959; // Earth's radius in miles
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLng = ((lng2 - lng1) * Math.PI) / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos((lat1 * Math.PI) / 180) *
      Math.cos((lat2 * Math.PI) / 180) *
      Math.sin(dLng / 2) *
      Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
```

**2. Compute distances for businesses:**
```typescript
const businessesWithDistance = useMemo(() => {
  const userPos = userLocation || { lat: userLat, lng: userLng };
  return businesses.map((business) => ({
    ...business,
    distance: calculateDistance(
      userPos.lat,
      userPos.lng,
      business.latitude,
      business.longitude
    ),
  }));
}, [businesses, userLocation, userLat, userLng]);
```

**3. Update popup to show distance:**
In the popup content, add distance display:
```typescript
<p className="text-sm text-gray-500">
  {business.distance !== undefined && (
    <>
      <span className="mr-2">üìè</span>
      {business.distance.toFixed(1)} miles away
    </>
  )}
</p>
```

**4. Update selected business card to show distance:**
In the Card below the map that shows selected business details, include:
```typescript
{selectedBusiness.distance !== undefined && (
  <p className="text-sm text-gray-500">
    {selectedBusiness.distance.toFixed(1)} miles away
  </p>
)}
```

**5. Optional: Sort businesses by distance:**
Consider sorting businessesWithDistance by distance so nearest appear first in any list. This is optional for this plan but sets up for Phase 3 list-map sync.

**Note:** The distance is calculated client-side using Haversine formula. The API already returns distance when lat/lng/radius params are provided, but recalculating client-side ensures accuracy when user location is obtained via geolocation (which may differ from the default Fremont coordinates).
  </action>
  <verify>
```bash
grep -q "calculateDistance\|Haversine" components/map/MapLibreMap.tsx && echo "Distance calculation present"
grep -q "miles away" components/map/MapLibreMap.tsx && echo "Distance display present"
```

Manual: Click a business marker, popup should show "X.X miles away". Select a business, detail card should show distance.
  </verify>
  <done>Business markers and popups display calculated distance from user location</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Geolocation flow:**
- On page load, browser prompts for location permission
- If granted: blue pulsing marker appears at user's actual location
- If denied: warning message shows, fallback marker at Fremont coordinates
- "Center on my location" button works (flies to user position)

2. **Distance display:**
- Business popup shows "X.X miles away"
- Selected business card shows distance
- Distances recalculate if user location changes

3. **Build check:**
```bash
npm run build
```
No errors, SSR still works.

4. **Type check:**
```bash
npx tsc --noEmit
```
No TypeScript errors.
</verification>

<success_criteria>
- [ ] UserLocationMarker.tsx renders blue pulsing marker
- [ ] Geolocation requested on map mount
- [ ] Permission denial handled gracefully with fallback
- [ ] "Center on my location" button flies to user position
- [ ] Business popup shows distance in miles
- [ ] Selected business card shows distance
- [ ] npm run build succeeds
- [ ] Works on both desktop and mobile browsers
</success_criteria>

<output>
After completion, create `.planning/phases/01-maplibre-foundation/01-02-SUMMARY.md`
</output>
