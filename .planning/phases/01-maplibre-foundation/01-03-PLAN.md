---
phase: 01-maplibre-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - app/search/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Search page displays a map showing business markers"
    - "User can toggle between list view and map view"
    - "Map markers correspond to search results"
    - "Clicking a marker shows business popup with details"
  artifacts:
    - path: "app/search/page.tsx"
      provides: "Search page with integrated MapLibre map"
      contains: "MapLibreMap"
  key_links:
    - from: "app/search/page.tsx"
      to: "components/map/MapLibreMap.tsx"
      via: "dynamic import with ssr: false"
      pattern: "dynamic.*MapLibreMap"
    - from: "app/search/page.tsx"
      to: "businesses state"
      via: "passing businesses array to map"
      pattern: "businesses=\\{businesses"
---

<objective>
Add map view to the search page to close verification gap from Phase 1.

Purpose: Phase 1 success criteria requires "Map renders with MapTiler vector tiles on search page AND homepage". The homepage has the map, but the search page only shows a list view. This plan adds the map to complete MAP-01 requirement.

Output: Search page has a view toggle (List/Map) and renders MapLibreMap when map view is selected, showing all search results as markers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-maplibre-foundation/01-VERIFICATION.md
@.planning/phases/01-maplibre-foundation/01-01-SUMMARY.md
@.planning/phases/01-maplibre-foundation/01-02-SUMMARY.md
@components/map/MapLibreMap.tsx
@components/map/BusinessMap.tsx
@app/search/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add view toggle and MapLibreMap to search page</name>
  <files>
    - app/search/page.tsx
  </files>
  <action>
Modify `app/search/page.tsx` to add a map view alongside the existing list view:

**1. Add dynamic import for MapLibreMap at the top of the file (after other imports):**
```typescript
import dynamic from "next/dynamic";

// Dynamic import to avoid SSR issues with WebGL
const MapLibreMap = dynamic(() => import("@/components/map/MapLibreMap"), {
  ssr: false,
  loading: () => (
    <div className="h-[500px] bg-gray-100 rounded-lg flex items-center justify-center">
      <p className="text-gray-500">Loading map...</p>
    </div>
  ),
});
```

**2. Add view state in SearchContent component (after existing useState declarations around line 45-47):**
```typescript
const [viewMode, setViewMode] = useState<"list" | "map">("list");
```

**3. Add view toggle buttons in the results header (around line 357, after "Found X businesses" text):**
Replace the simple `<p>` with a flex container that includes view toggle:
```typescript
<div className="flex items-center justify-between mb-6">
  <p className="text-gray-600">
    Found <strong>{businesses.length}</strong> businesses
    {userLocation && ` within ${filters.distance} miles`}
  </p>
  <div className="flex items-center gap-2">
    {favorites.length > 0 && (
      <Link href="/favorites">
        <Button variant="outline" size="sm">
          View Favorites ({favorites.length})
        </Button>
      </Link>
    )}
    {/* View Toggle */}
    <div className="flex border rounded-lg overflow-hidden">
      <button
        onClick={() => setViewMode("list")}
        className={`px-3 py-1.5 text-sm font-medium transition-colors ${
          viewMode === "list"
            ? "bg-primary text-white"
            : "bg-white text-gray-600 hover:bg-gray-50"
        }`}
      >
        List
      </button>
      <button
        onClick={() => setViewMode("map")}
        className={`px-3 py-1.5 text-sm font-medium transition-colors ${
          viewMode === "map"
            ? "bg-primary text-white"
            : "bg-white text-gray-600 hover:bg-gray-50"
        }`}
      >
        Map
      </button>
    </div>
  </div>
</div>
```

**4. Transform businesses data for MapLibreMap (add this before the return statement, around line 188):**
The search page Business interface differs from MapLibreMap's expectations. Create a mapped array:
```typescript
// Transform businesses for map component (needs latitude/longitude)
const businessesForMap = useMemo(() => {
  return businesses
    .filter((b: any) => b.latitude && b.longitude) // Only include businesses with coordinates
    .map((b: any) => ({
      id: b.id,
      name: b.name,
      category: b.category,
      address: b.address,
      city: b.city,
      latitude: b.latitude,
      longitude: b.longitude,
      averageRating: b.averageRating,
      reviewCount: b.reviewCount,
      distance: b.distance,
      tags: b.tags?.map((t: any) => t.tag || t) || [],
      imageUrl: b.photos?.[0]?.url,
      description: b.description,
    }));
}, [businesses]);
```
Note: Add `useMemo` to the imports from React if not already present.

**5. Conditionally render map or list view (replace the grid section around line 371):**
```typescript
{viewMode === "list" ? (
  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {/* ... existing business cards JSX ... */}
  </div>
) : (
  <div className="h-[600px] rounded-lg overflow-hidden border">
    <MapLibreMap
      businesses={businessesForMap}
      userLat={userLocation?.lat ?? 37.5485}
      userLng={userLocation?.lng ?? -121.9886}
      radius={parseInt(filters.distance) || 25}
    />
  </div>
)}
```

**6. Update Business interface to include latitude/longitude (around line 21):**
The interface needs lat/lng for the map to work:
```typescript
interface Business {
  id: string;
  name: string;
  description: string;
  category: string;
  address: string;
  city: string;
  phone: string;
  averageRating: number;
  reviewCount: number;
  priceRange?: string;
  verificationStatus?: string;
  tags: { tag: string }[];
  photos: { url: string }[];
  distance?: number;
  latitude?: number;   // Add this
  longitude?: number;  // Add this
}
```

**Important notes:**
- Use the same default coordinates (37.5485, -121.9886) as BusinessMap for consistency
- The API already returns latitude/longitude for businesses, we just weren't using them
- Keep the existing list view exactly as-is, just wrap it in the conditional
- The map height of 600px matches the homepage BusinessMap height
  </action>
  <verify>
```bash
# Check MapLibreMap is imported dynamically
grep -q "dynamic.*MapLibreMap" app/search/page.tsx && echo "Dynamic import present"

# Check view toggle state exists
grep -q "viewMode.*list.*map" app/search/page.tsx && echo "View mode state present"

# Check map is rendered
grep -q "<MapLibreMap" app/search/page.tsx && echo "MapLibreMap rendered"
```

Manual verification:
1. Open localhost:3000/search
2. Click "Map" toggle button
3. Map should appear with business markers
4. Click "List" to return to list view
  </verify>
  <done>Search page has List/Map toggle and renders MapLibreMap showing search results as markers</done>
</task>

</tasks>

<verification>
After task completion:

1. **Visual check:**
- Navigate to localhost:3000/search
- Default view is List (cards grid)
- Click "Map" button - map appears with markers
- Click "List" button - returns to cards grid

2. **Map functionality:**
- Markers appear for businesses with coordinates
- Clicking a marker shows popup with business details
- User location marker appears (if permission granted)
- Popup "View Details" navigates to business page

3. **Filter interaction:**
- Apply a category filter
- Map markers update to show only filtered businesses
- Change distance filter
- Businesses outside range disappear from map

4. **Build check:**
```bash
npm run build
```
No errors, SSR works correctly.

5. **Type check:**
```bash
npx tsc --noEmit
```
No TypeScript errors.
</verification>

<success_criteria>
- [ ] Search page has List/Map view toggle buttons
- [ ] Default view is List (existing behavior preserved)
- [ ] Clicking "Map" shows MapLibreMap component
- [ ] Map displays markers for search results
- [ ] Markers have correct category colors/icons
- [ ] Clicking marker shows business popup
- [ ] View Details in popup navigates to business page
- [ ] Filters apply to both list and map views
- [ ] npm run build succeeds without errors
- [ ] No hydration errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/01-maplibre-foundation/01-03-SUMMARY.md`
</output>
