---
phase: 01.1-web-scraping-revamp
plan: 03
type: execute
wave: 2
depends_on: ["01.1-01"]
files_modified:
  - app/admin/businesses/review-queue/page.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can see validation score for each scraped business"
    - "Admin can see validation flags/warnings"
    - "Low-confidence businesses are visually distinguished"
    - "Full scrape-to-directory flow works end-to-end"
  artifacts:
    - path: "app/admin/businesses/review-queue/page.tsx"
      provides: "UI showing validation scores and flags"
      contains: "validateBusinessEntry"
  key_links:
    - from: "app/admin/businesses/review-queue/page.tsx"
      to: "lib/scraper/validation.ts"
      via: "import and call validateBusinessEntry"
      pattern: "validateBusinessEntry"
---

<objective>
Surface business validation in the admin review queue UI and verify the complete scrape-to-directory flow works end-to-end.

Purpose: Validation logic from Plan 01 needs to be surfaced in the UI so admins can see confidence scores and warning flags when reviewing scraped businesses. Then verify the complete flow works.

Output:
- Enhanced review queue UI with validation display
- End-to-end verification that scraped businesses appear on /businesses after approval
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-web-scraping-revamp/01.1-RESEARCH.md
@.planning/phases/01.1-web-scraping-revamp/01.1-01-SUMMARY.md

# Key files to reference
@app/admin/businesses/review-queue/page.tsx
@lib/scraper/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Surface validation in review queue UI</name>
  <files>app/admin/businesses/review-queue/page.tsx</files>
  <action>
Enhance the review queue page to display validation results for each scraped business.

1. Add import at top of file:
```typescript
import { validateBusinessEntry, ValidationResult } from "@/lib/scraper/validation";
```

2. In the component where scraped businesses are displayed, add validation computation.

The page likely fetches scraped businesses and renders them in a list/table. For each business, compute and display validation:

```typescript
// In the component, create a helper or use useMemo
const getValidation = (business: ScrapedBusiness): ValidationResult => {
  return validateBusinessEntry(business);
};
```

3. Add validation display in the business card/row UI. Look for where individual businesses are rendered and add:

```tsx
{/* Validation Score Badge */}
<div className="flex items-center gap-2">
  {(() => {
    const validation = getValidation(business);
    return (
      <>
        <span
          className={`px-2 py-0.5 rounded-full text-xs font-medium ${
            validation.confidence >= 70
              ? "bg-green-100 text-green-800"
              : validation.confidence >= 50
              ? "bg-yellow-100 text-yellow-800"
              : "bg-red-100 text-red-800"
          }`}
        >
          {validation.confidence}% confidence
        </span>
        {!validation.isLikelyBusiness && (
          <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
            Low Quality
          </span>
        )}
      </>
    );
  })()}
</div>

{/* Validation Flags */}
{(() => {
  const validation = getValidation(business);
  if (validation.flags.length > 0) {
    return (
      <div className="mt-2 flex flex-wrap gap-1">
        {validation.flags.map((flag, i) => (
          <span
            key={i}
            className="px-2 py-0.5 rounded text-xs bg-orange-100 text-orange-800"
          >
            {flag.replace(/_/g, " ")}
          </span>
        ))}
      </div>
    );
  }
  return null;
})()}
```

4. Optionally add sorting/filtering by validation score:
- Add a filter dropdown to show "High confidence only" (>70)
- Add sort option to sort by confidence score descending

5. Consider memoizing validation results if performance is a concern (use useMemo with business.id as key).

Note: The exact JSX structure depends on the existing page layout. Adapt the above to fit the current card/table structure. The key is:
- Show confidence score with color coding (green >70, yellow 50-70, red <50)
- Show "Low Quality" badge if isLikelyBusiness is false
- Show flags as warning badges
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit app/admin/businesses/review-queue/page.tsx`
Verify import: `grep -n "validateBusinessEntry" app/admin/businesses/review-queue/page.tsx`
Start dev server and visit /admin/businesses/review-queue to see validation badges
  </verify>
  <done>
- Review queue imports validateBusinessEntry from validation.ts
- Each scraped business shows confidence score with color coding
- Low quality businesses show warning badge
- Validation flags displayed as warning badges
- TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete web scraping revamp:
1. Business validation module with confidence scoring
2. Enhanced approval transfer (photos, tags, hours)
3. Cross-table deduplication
4. Hours extraction from Google Places
5. Validation UI in review queue
  </what-built>
  <how-to-verify>
**Test the full flow:**

1. **Start dev server:**
   ```bash
   npm run dev
   ```

2. **Access admin scraper (requires admin auth):**
   - Visit: http://localhost:3000/admin/businesses/scraper
   - Run a test scrape with "halal restaurant" in Fremont, CA

3. **Review scraped businesses:**
   - Visit: http://localhost:3000/admin/businesses/review-queue
   - Verify: Each business shows confidence score badge
   - Verify: Low quality businesses show warning flags
   - Verify: Color coding works (green/yellow/red)

4. **Approve a business:**
   - Click approve on a high-confidence business
   - Check the response includes photosTransferred and tagsTransferred counts

5. **Verify on public directory:**
   - Visit: http://localhost:3000/businesses
   - Search for the approved business name
   - Verify: Business appears in directory
   - Verify: Business has images (if scraped source had photos)
   - Verify: Business shows on map

6. **Check database (optional):**
   ```bash
   npx prisma studio
   ```
   - Open Business table, find the approved business
   - Verify: hours field populated (if source had hours)
   - Open BusinessPhoto table
   - Verify: Photos linked to business ID
   - Open BusinessTagRelation table
   - Verify: Tags linked to business ID

**Expected Results:**
- Scraper produces businesses with confidence scores
- Review queue shows validation visually
- Approval creates Business with photos, tags, hours
- Business appears on /businesses page
- Business appears on map
  </how-to-verify>
  <resume-signal>Type "approved" if flow works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles:
   ```bash
   npx tsc --noEmit
   ```

2. Validation import present:
   ```bash
   grep "validateBusinessEntry" app/admin/businesses/review-queue/page.tsx
   ```

3. Manual verification of full flow (checkpoint task)
</verification>

<success_criteria>
- [ ] Review queue shows confidence score for each business
- [ ] Low quality businesses visually distinguished
- [ ] Validation flags shown as warning badges
- [ ] Full scrape -> review -> approve -> directory flow works
- [ ] Approved businesses appear on /businesses page
- [ ] Photos, tags, hours transferred correctly on approval
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-web-scraping-revamp/01.1-03-SUMMARY.md`
</output>
