---
phase: 02-clustering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/map/clusterLayers.ts
  - components/map/MapLibreMap.tsx
autonomous: true

must_haves:
  truths:
    - "Business markers cluster when zoomed out"
    - "Cluster markers display count of businesses within"
    - "Clicking a cluster zooms the map to reveal individual markers"
    - "Individual markers appear when sufficiently zoomed in"
    - "Clicking an individual marker shows popup with business details"
  artifacts:
    - path: "components/map/clusterLayers.ts"
      provides: "Layer style definitions for clusters and points"
      exports: ["clusterLayer", "clusterCountLayer", "unclusteredPointLayer"]
    - path: "components/map/MapLibreMap.tsx"
      provides: "Map component with native clustering"
      contains: "Source.*cluster={true}"
  key_links:
    - from: "components/map/MapLibreMap.tsx"
      to: "components/map/clusterLayers.ts"
      via: "import"
      pattern: "import.*from.*clusterLayers"
    - from: "Source component"
      to: "Layer components"
      via: "source prop matching"
      pattern: "source:\\s*['\"]businesses['\"]"
---

<objective>
Implement native MapLibre clustering for business markers to enable smooth map performance with 50+ businesses.

Purpose: Replace DOM-based Marker components with layer-based rendering using MapLibre's built-in GeoJSON clustering. This improves performance (WebGL vs DOM) and provides automatic cluster management.

Output: MapLibreMap.tsx refactored to use Source/Layer architecture with clustering, plus a new clusterLayers.ts file for layer style definitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-clustering/02-RESEARCH.md

# Current implementation to modify
@components/map/MapLibreMap.tsx
@components/map/UserLocationMarker.tsx
@components/map/BusinessMap.tsx (for CATEGORIES constant)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cluster layer definitions</name>
  <files>components/map/clusterLayers.ts</files>
  <action>
Create a new file `components/map/clusterLayers.ts` with layer style definitions for:

1. **clusterLayer** (type: circle):
   - Filter: `['has', 'point_count']`
   - Color by count: green (#16a34a) for 0-9, yellow (#eab308) for 10-49, orange (#f97316) for 50+
   - Radius by count: 20px (small), 30px (medium), 40px (large)
   - White stroke (2px)

2. **clusterCountLayer** (type: symbol):
   - Filter: `['has', 'point_count']`
   - Text field: `{point_count_abbreviated}`
   - Text size: 14
   - Text color: white
   - Font: `['Noto Sans Bold']` (available in MapTiler streets-v2)

3. **unclusteredPointLayer** (type: circle):
   - Filter: `['!', ['has', 'point_count']]`
   - Color: green (#16a34a) to match brand
   - Radius: 12px
   - White stroke (3px)

All layers must:
- Use `source: 'businesses'` to match the Source id
- Import LayerProps from 'react-map-gl/maplibre'
- Be defined as constants (not inline) to prevent re-renders

Reference: 02-RESEARCH.md Pattern 2 and Code Examples section.
  </action>
  <verify>
File exists and exports all three layer constants:
```bash
cat components/map/clusterLayers.ts | grep -E "export const (clusterLayer|clusterCountLayer|unclusteredPointLayer)"
```
Expected: 3 lines showing exports
  </verify>
  <done>clusterLayers.ts exists with clusterLayer, clusterCountLayer, and unclusteredPointLayer exported as typed LayerProps constants</done>
</task>

<task type="auto">
  <name>Task 2: Refactor MapLibreMap to use Source/Layer clustering</name>
  <files>components/map/MapLibreMap.tsx</files>
  <action>
Refactor `components/map/MapLibreMap.tsx` to replace Marker-based rendering with Source/Layer clustering:

**1. Update imports:**
- Add: `Source, Layer` from 'react-map-gl/maplibre'
- Add: `MapMouseEvent` type from 'react-map-gl/maplibre'
- Add: `GeoJSONSource` type from 'maplibre-gl'
- Import layer definitions from './clusterLayers'
- Remove: individual Marker import (keep Popup, NavigationControl)

**2. Add GeoJSON conversion (useMemo):**
```typescript
const geojsonData = useMemo((): GeoJSON.FeatureCollection<GeoJSON.Point> => ({
  type: 'FeatureCollection',
  features: businessesWithDistance.map(business => ({
    type: 'Feature',
    properties: {
      id: business.id,
      name: business.name,
      category: business.category,
      address: business.address,
      city: business.city,
      averageRating: business.averageRating,
      reviewCount: business.reviewCount,
      distance: business.distance,
      tags: business.tags,
      imageUrl: business.imageUrl
    },
    geometry: {
      type: 'Point',
      coordinates: [business.longitude, business.latitude]
    }
  }))
}), [businessesWithDistance]);
```

**3. Create unified click handler:**
```typescript
const onMapClick = useCallback(async (event: MapMouseEvent) => {
  const feature = event.features?.[0];
  if (!feature) {
    setSelectedBusiness(null);
    return;
  }

  // Cluster click - zoom to expand
  const clusterId = feature.properties?.cluster_id;
  if (clusterId !== undefined) {
    const source = mapRef.current?.getSource('businesses') as GeoJSONSource;
    const zoom = await source.getClusterExpansionZoom(clusterId);
    mapRef.current?.easeTo({
      center: (feature.geometry as GeoJSON.Point).coordinates as [number, number],
      zoom,
      duration: 500
    });
    return;
  }

  // Individual point click - show popup
  const businessId = feature.properties?.id;
  const business = businessesWithDistance.find(b => b.id === businessId);
  if (business) {
    setSelectedBusiness(business);
  }
}, [businessesWithDistance]);
```

**4. Update Map component props:**
- Add: `interactiveLayerIds={['clusters', 'unclustered-point']}`
- Add: `onClick={onMapClick}`

**5. Replace Marker loop with Source/Layer:**
Remove the entire `{businessesWithDistance.map((business) => ...)}` block.

Add inside Map component (after NavigationControl, before UserLocationMarker):
```tsx
<Source
  id="businesses"
  type="geojson"
  data={geojsonData}
  cluster={true}
  clusterMaxZoom={14}
  clusterRadius={50}
>
  <Layer {...clusterLayer} />
  <Layer {...clusterCountLayer} />
  <Layer {...unclusteredPointLayer} />
</Source>
```

**6. Preserve existing functionality:**
- Keep UserLocationMarker unchanged
- Keep Popup component (it uses selectedBusiness state)
- Keep location button and geolocation logic
- Keep the selected business details Card below map
- Keep all CSS styles

**7. Remove unused state:**
- Remove `hoveredBusinessId` state (hover not supported with layers, deferred to Phase 5)
- Remove related `onMouseEnter`/`onMouseLeave` handlers

**8. Remove unused functions:**
- Remove `adjustColor` function (only used in popup, but popup uses getCategoryInfo which is still needed)
- Actually keep `adjustColor` - it's used in the popup gradient

Note: The popup content remains unchanged - when selectedBusiness is set, it renders the same rich popup with image/gradient, category icon, rating, tags, address, and View Details button.
  </action>
  <verify>
1. TypeScript compiles:
```bash
cd /Users/saeed/Desktop/Manaakhah && npx tsc --noEmit 2>&1 | grep -E "(MapLibreMap|clusterLayers)" || echo "No type errors"
```

2. Source and Layer components present:
```bash
grep -E "(<Source|<Layer)" components/map/MapLibreMap.tsx | head -5
```

3. Clustering configured:
```bash
grep -E "cluster(MaxZoom|Radius|={true})" components/map/MapLibreMap.tsx
```

4. Interactive layers set:
```bash
grep "interactiveLayerIds" components/map/MapLibreMap.tsx
```
  </verify>
  <done>MapLibreMap.tsx uses Source/Layer architecture with cluster={true}, clusterMaxZoom={14}, clusterRadius={50}, click handlers for cluster zoom and point popup, and all existing popup/geolocation functionality preserved</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full clustering implementation:

1. **Build passes:**
```bash
cd /Users/saeed/Desktop/Manaakhah && npm run build 2>&1 | tail -20
```

2. **Visual verification (manual):**
- Start dev server: `npm run dev`
- Navigate to search page or homepage with map
- Zoom out - markers should cluster into numbered circles
- Zoom in past level 14 - individual green markers appear
- Click cluster - map zooms to expand cluster
- Click individual marker - popup shows business details

3. **No Marker imports remaining:**
```bash
grep "Marker" components/map/MapLibreMap.tsx | grep -v "UserLocationMarker" || echo "No Marker imports"
```
</verification>

<success_criteria>
1. Business markers cluster when zoomed out (radius ~50px)
2. Cluster markers display count of businesses within (colored circles with numbers)
3. Clicking a cluster zooms the map to reveal individual markers (via getClusterExpansionZoom)
4. Individual markers appear when sufficiently zoomed in (max zoom 14)
5. Clicking individual marker shows existing popup with business details
6. User location marker still displays correctly
7. Geolocation and "center on me" button still work
8. Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-clustering/02-01-SUMMARY.md` using the summary template.
</output>
