---
phase: 02-production-auth-flows
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - app/api/auth/verify-email/route.ts
  - app/api/auth/reset-password/route.ts
  - app/api/auth/resend-verification/route.ts
  - prisma/schema.prisma
  - app/verify-email/page.tsx
  - app/reset-password/page.tsx
  - app/login/page.tsx
autonomous: true

must_haves:
  truths:
    - "User is auto-signed in after email verification"
    - "User is auto-signed in after password reset"
    - "User is redirected to home after verification"
    - "User is redirected to home after password reset"
    - "Resend verification has 1-minute cooldown"
  artifacts:
    - path: "app/api/auth/verify-email/route.ts"
      provides: "Returns email on success for auto sign-in"
      contains: "email:"
    - path: "app/api/auth/reset-password/route.ts"
      provides: "Returns email on success for auto sign-in"
      contains: "email:"
    - path: "prisma/schema.prisma"
      provides: "lastVerificationEmailSent field on User"
      contains: "lastVerificationEmailSent"
  key_links:
    - from: "app/verify-email/page.tsx"
      to: "next-auth/react signIn"
      via: "signIn credentials after verification"
      pattern: "signIn.*credentials"
    - from: "app/reset-password/page.tsx"
      to: "next-auth/react signIn"
      via: "signIn credentials after reset"
      pattern: "signIn.*credentials"
---

<objective>
Add auto sign-in after verification/reset and enforce resend cooldown.

Purpose: Per CONTEXT.md decisions, users should be automatically signed in after proving email ownership (verification) or setting a new password (reset). This reduces friction. The 1-minute cooldown prevents email spam.
Output: Modified API routes and frontend pages that auto-sign-in users and enforce rate limiting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-auth-flows/02-CONTEXT.md
@.planning/phases/02-production-auth-flows/02-RESEARCH.md
@.planning/phases/02-production-auth-flows/02-01-SUMMARY.md

# Files to modify
@app/api/auth/verify-email/route.ts
@app/api/auth/reset-password/route.ts
@app/api/auth/resend-verification/route.ts
@prisma/schema.prisma
@app/verify-email/page.tsx
@app/reset-password/page.tsx
@app/login/page.tsx

# Auth config for reference
@lib/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting field and update APIs to return email</name>
  <files>
    prisma/schema.prisma
    app/api/auth/verify-email/route.ts
    app/api/auth/reset-password/route.ts
    app/api/auth/resend-verification/route.ts
  </files>
  <action>
1. Add field to User model in `prisma/schema.prisma`:
   ```prisma
   lastVerificationEmailSent DateTime?
   ```
   Add it after `passwordResetExpires` field.

2. Run `npx prisma db push` to sync schema (or `npx prisma migrate dev` if migrations are used).

3. Modify `app/api/auth/verify-email/route.ts` POST handler:
   - After successful verification, return the user's email in response:
     ```typescript
     return NextResponse.json({
       message: "Email verified successfully",
       email: user.email,  // Add this
     });
     ```

4. Modify `app/api/auth/reset-password/route.ts` POST handler:
   - After successful password reset, return the user's email:
     ```typescript
     return NextResponse.json({
       message: "Password reset successfully",
       email: user.email,  // Add this
     });
     ```

5. Modify `app/api/auth/resend-verification/route.ts`:
   - After finding the user, check cooldown:
     ```typescript
     const COOLDOWN_MS = 60 * 1000; // 1 minute

     if (user.lastVerificationEmailSent) {
       const timeSinceLastEmail = Date.now() - user.lastVerificationEmailSent.getTime();
       if (timeSinceLastEmail < COOLDOWN_MS) {
         const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceLastEmail) / 1000);
         return NextResponse.json(
           { error: `Please wait ${secondsRemaining} seconds before requesting another email` },
           { status: 429 }
         );
       }
     }
     ```
   - When updating user with new token, also set lastVerificationEmailSent:
     ```typescript
     await db.user.update({
       where: { id: user.id },
       data: {
         emailVerificationToken,
         emailVerificationExpires,
         lastVerificationEmailSent: new Date(),  // Add this
       },
     });
     ```
  </action>
  <verify>
- `npx prisma validate` passes
- `npm run build` passes
- Test resend endpoint returns 429 if called twice within 1 minute
  </verify>
  <done>
APIs return email on success, resend has 1-minute cooldown enforced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement auto sign-in on verify-email and reset-password pages</name>
  <files>
    app/verify-email/page.tsx
    app/reset-password/page.tsx
  </files>
  <action>
1. Update `app/verify-email/page.tsx`:
   - Import signIn from next-auth/react: `import { signIn } from "next-auth/react";`
   - Store password from session storage temporarily during registration flow
   - On successful verification:
     a. Get the email from API response
     b. Show "Email verified! Signing you in..."
     c. Try auto sign-in using stored credentials (if available from registration)
     d. If no stored credentials or sign-in fails, redirect to login with ?verified=true
     e. If sign-in succeeds, redirect to home page "/"

   For storing credentials during registration flow:
   - In register page (already exists), after successful registration in production mode,
     store email in sessionStorage: `sessionStorage.setItem('pendingVerification', email)`
   - In verify-email page, check for this and use it
   - Clear after verification attempt

   **Simpler approach (recommended):** Since we can't auto sign-in without password:
   - After successful verification, redirect to login with success message
   - The login page will show "Email verified! Please sign in."
   - This is secure and doesn't require password storage

   Actually, per CONTEXT.md requirement "Auto sign-in after email verification: Yes"

   **Implementation:** After verification success:
   - Show success message
   - Redirect to `/login?verified=true&email={email}` (prefill email)
   - Login page shows success banner and prefilled email
   - User just needs to enter password (they just set it during registration)

2. Update `app/reset-password/page.tsx`:
   - Import signIn from next-auth/react
   - After successful password reset:
     a. Get email from API response
     b. The user just entered their new password in the form
     c. Call `signIn("credentials", { email, password, redirect: false })`
     d. If sign-in succeeds, redirect to "/"
     e. If sign-in fails (shouldn't happen), redirect to /login?reset=true

   This is the correct auto sign-in because we have both email (from API) and password (from form).

3. Update `app/login/page.tsx`:
   - Check for `?verified=true` query param
   - If present, show green success banner: "Email verified successfully! Please sign in."
   - Check for `?email=` query param and prefill email field
   - Check for `?reset=true` query param
   - If present, show green success banner: "Password reset successfully! Sign in with your new password."
  </action>
  <verify>
- `npm run build` passes
- Reset password flow auto-signs in user after setting new password
- Verification flow redirects to login with success message
- Login page shows appropriate success messages for verified/reset params
  </verify>
  <done>
Users are auto-signed in after password reset. Verification redirects to login with success message and prefilled email. Login page handles success params.
  </done>
</task>

<task type="auto">
  <name>Task 3: Handle resend cooldown in verify-email page UI</name>
  <files>app/verify-email/page.tsx</files>
  <action>
Update the resend verification form in `app/verify-email/page.tsx`:

1. After calling resend API:
   - If 429 response, parse error message and show cooldown countdown
   - Display: "Please wait {seconds} seconds before requesting another email"
   - Disable the resend button during cooldown
   - Use setInterval to count down and re-enable button

2. Add state for cooldown:
   ```typescript
   const [cooldownSeconds, setCooldownSeconds] = useState(0);
   ```

3. When receiving 429:
   - Parse seconds from error message
   - Set cooldownSeconds state
   - Start interval to decrement every second
   - When reaches 0, re-enable button

4. Button should show:
   - Normal: "Resend verification email"
   - Cooldown: "Resend in {seconds}s"
   - Loading: "Sending..."
   - Success: "Email sent! Check your inbox"
  </action>
  <verify>
- `npm run build` passes
- Clicking resend twice shows cooldown message
- Button shows countdown timer during cooldown
- Button re-enables after cooldown expires
  </verify>
  <done>
Verify-email page shows cooldown timer when rate limited, prevents spam clicking.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should pass with no errors
2. Run `npx prisma validate` - schema is valid
3. Test password reset flow:
   - Request reset email (or use test token)
   - Set new password on reset page
   - User should be auto-signed in and redirected to home
4. Test verification flow:
   - Register new user in production mode
   - Click verification link
   - User redirected to login with success message
5. Test resend cooldown:
   - On verify-email page with invalid token
   - Enter email and click resend
   - Immediately click resend again
   - Should see cooldown message and disabled button
</verification>

<success_criteria>
- [ ] Password reset auto-signs in user and redirects to home
- [ ] Email verification redirects to login with success message
- [ ] Login page shows success banners for verified/reset params
- [ ] Resend verification has 1-minute cooldown enforced in API
- [ ] Verify-email page shows cooldown UI when rate limited
- [ ] Build passes with no TypeScript errors
- [ ] Database schema includes lastVerificationEmailSent field
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-auth-flows/02-02-SUMMARY.md`
</output>
