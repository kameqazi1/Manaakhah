---
phase: 03-search-to-map-sync
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/search/page.tsx
  - components/search/ViewToggle.tsx
autonomous: true

must_haves:
  truths:
    - "Search results cause map to fit bounds to show all results"
    - "Changing filters updates markers on map immediately"
    - "List view, map view, and split view toggle works"
    - "URL reflects current filter state (shareable)"
  artifacts:
    - path: "app/search/page.tsx"
      provides: "Unified search page with map sync"
      contains: "useMapSearch"
    - path: "components/search/ViewToggle.tsx"
      provides: "List/Map/Split toggle component"
      exports: ["ViewToggle"]
  key_links:
    - from: "app/search/page.tsx"
      to: "hooks/useMapSearch.ts"
      via: "hook import"
      pattern: "import.*useMapSearch"
    - from: "app/search/page.tsx"
      to: "components/map/MapLibreMap.tsx"
      via: "businesses prop"
      pattern: "MapLibreMap.*businesses"
---

<objective>
Integrate useMapSearch hook into search page with view toggles

Purpose: Connect the useMapSearch hook (from Plan 01) to the search page, enabling immediate map updates when filters change, automatic fitBounds on search results, and list/map/split view modes.

Output:
- Search page refactored to use useMapSearch hook (URL-first state)
- ViewToggle component with list/map/split modes
- Map automatically fits bounds when search results change
- Filters sync to URL (shareable links work)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-search-to-map-sync/03-RESEARCH.md
@.planning/phases/03-search-to-map-sync/03-01-SUMMARY.md

# Current implementations
@app/search/page.tsx
@components/map/MapLibreMap.tsx
@hooks/useMapSearch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ViewToggle component</name>
  <files>components/search/ViewToggle.tsx</files>
  <action>
Create a reusable view toggle component:

1. Create components/search/ViewToggle.tsx (new file)

2. Define ViewMode type:
```typescript
export type ViewMode = 'list' | 'map' | 'split';
```

3. Props interface:
```typescript
interface ViewToggleProps {
  value: ViewMode;
  onChange: (mode: ViewMode) => void;
}
```

4. Component styling:
- Use same button group pattern as existing toggle in search page
- Three buttons: List, Map, Split
- Active state: bg-primary text-white
- Inactive state: bg-white text-gray-600 hover:bg-gray-50
- Rounded border container
- Use cn utility for class merging

5. Include icons (optional but nice):
- List: grid/list icon
- Map: map pin icon
- Split: columns icon
Use inline SVG or emoji if no icon library available.

IMPORTANT: Add 'use client' directive.
  </action>
  <verify>
```bash
# File exists and exports correctly
grep -l "ViewToggle" components/search/ViewToggle.tsx
npx tsc --noEmit
```
  </verify>
  <done>
ViewToggle component exists, exports ViewMode type and ViewToggle component. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor search page to use useMapSearch hook</name>
  <files>app/search/page.tsx</files>
  <action>
Major refactor of search page to use URL-first state via useMapSearch:

1. REMOVE these useState calls:
- `const [businesses, setBusinesses] = useState<Business[]>([]);`
- `const [loading, setLoading] = useState(true);`
- `const [filters, setFilters] = useState({...});`

2. REPLACE with useMapSearch hook:
```typescript
const { filters, setFilters, businesses, isLoading, error } = useMapSearch(userLocation);
```

3. KEEP these useState calls (local UI state):
- `userLocation` (geolocation)
- `favorites` (localStorage)
- `recentlyViewed` (localStorage)
- `showAdvancedFilters` (UI toggle)
- `viewMode` - but change type to ViewMode from ViewToggle

4. REMOVE fetchBusinesses callback and its useEffect - React Query handles this now.

5. UPDATE handleSearch:
- No longer calls fetchBusinesses
- Just updates URL params via setFilters (React Query auto-refetches)
```typescript
const handleSearch = (e: React.FormEvent) => {
  e.preventDefault();
  // Filters already sync to URL via setFilters, so nothing to do here
  // Or optionally trigger a refetch if needed
};
```

6. UPDATE filter change handlers:
- All setFilters calls now update URL params
- Example: `setFilters({ search: e.target.value })`

7. UPDATE loading check:
- Replace `loading` with `isLoading`

8. Import useMapSearch from '@/hooks/useMapSearch'

9. Import ViewToggle component and use it in place of inline toggle buttons

10. Handle sort option change - need to add sort to URL params:
- The sorting happens on client side currently, keep that behavior
- Or add sort to API later (out of scope for this plan)

NOTE: Keep the client-side sorting in a useMemo that derives from businesses array.
  </action>
  <verify>
```bash
npm run dev
# Visit http://localhost:3000/search
# - Page loads without errors
# - Changing filters updates URL params
# - Refreshing page preserves filters from URL
```
  </verify>
  <done>
Search page uses useMapSearch hook. Filters sync to URL. Page works without console errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add split view layout and fitBounds trigger</name>
  <files>app/search/page.tsx</files>
  <action>
Implement split view and verify fitBounds works:

1. UPDATE viewMode state to use ViewMode type:
```typescript
const [viewMode, setViewMode] = useState<ViewMode>('list');
```

2. ADD split view layout in results section:
```typescript
{viewMode === 'split' ? (
  <div className="grid md:grid-cols-2 gap-6">
    {/* List on left */}
    <div className="space-y-4 max-h-[600px] overflow-y-auto">
      {/* Business cards - smaller variant */}
    </div>
    {/* Map on right */}
    <div className="h-[600px] rounded-lg overflow-hidden border sticky top-24">
      <MapLibreMap businesses={businessesForMap} ... />
    </div>
  </div>
) : viewMode === 'map' ? (
  // Existing map view
) : (
  // Existing list view
)}
```

3. VERIFY fitBounds:
- MapLibreMap already has fitBounds effect that triggers on businesses change
- When filters change -> React Query refetches -> businesses update -> map fitBounds
- This should work automatically due to existing implementation in MapLibreMap.tsx

4. ENSURE businessesForMap derives from hook's businesses:
- Keep existing useMemo that transforms businesses to map format
- It should already reference the businesses from useMapSearch

5. Mobile consideration:
- On mobile (md breakpoint), split view stacks vertically
- Map gets fixed height (400px on mobile, 600px on desktop)
- Consider hiding split option on mobile or making it stack

6. UPDATE ViewToggle usage:
```typescript
<ViewToggle value={viewMode} onChange={setViewMode} />
```
  </action>
  <verify>
```bash
npm run dev
# Test all three view modes:
# 1. List view - shows business cards grid
# 2. Map view - shows full map with markers
# 3. Split view - shows list on left, map on right

# Test fitBounds:
# 1. Change category filter
# 2. Map should animate to fit new results

# Test URL sharing:
# 1. Apply some filters
# 2. Copy URL
# 3. Open in new tab
# 4. Filters should be preserved
```
  </verify>
  <done>
All three view modes work. Map fits bounds when results change. URL preserves filter state.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. View modes work:
- List view shows business cards in grid
- Map view shows full-width map with markers
- Split view shows list and map side by side

2. Filter sync:
- Changing any filter updates URL params
- URL params applied on page load
- React Query refetches when URL changes

3. Map fitBounds:
- Apply a filter that changes results
- Map animates to fit new marker bounds

4. Build succeeds:
```bash
npm run build
```

5. Success criteria from phase goal:
- [ ] Search results cause map to fit bounds to show all results
- [ ] Changing filters updates markers on map immediately
- [ ] List view, map view, and split view toggle works on search page
</verification>

<success_criteria>
- [ ] ViewToggle component exists with list/map/split options
- [ ] Search page uses useMapSearch hook (no local fetch logic)
- [ ] Filters sync to URL params (shareable links)
- [ ] All three view modes render correctly
- [ ] Map fitBounds triggers when search results change
- [ ] TypeScript compiles without errors
- [ ] Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-search-to-map-sync/03-02-SUMMARY.md`
</output>
