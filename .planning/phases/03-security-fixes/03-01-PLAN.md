---
phase: 03-security-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/env.ts
  - next.config.js
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "App fails fast with clear error if required env vars missing in production"
    - "Mock auth headers (x-user-id, x-user-role) are logged when sent outside mock mode"
    - "Repeated mock header attempts from same IP trigger blocking log"
    - "Real auth continues normally even when mock headers are sent"
  artifacts:
    - path: "lib/env.ts"
      provides: "Type-safe environment validation using @t3-oss/env-nextjs"
      exports: ["env"]
    - path: "middleware.ts"
      provides: "Mock header detection and rate-limited logging"
      exports: ["middleware", "config"]
  key_links:
    - from: "next.config.js"
      to: "lib/env.ts"
      via: "import for build-time validation"
      pattern: "require.*lib/env"
    - from: "middleware.ts"
      to: "process.env.USE_MOCK_DATA"
      via: "mode check"
      pattern: "USE_MOCK_DATA.*true"
---

<objective>
Add environment validation and mock header protection middleware.

Purpose: Prevent misconfigurations from reaching production and detect/log mock header abuse attempts without revealing detection to attackers.

Output: `lib/env.ts` for type-safe env validation, `middleware.ts` for mock header protection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-fixes/03-CONTEXT.md
@.planning/phases/03-security-fixes/03-RESEARCH.md
@lib/db.ts
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Environment validation with @t3-oss/env-nextjs</name>
  <files>lib/env.ts, next.config.js, package.json</files>
  <action>
1. Install @t3-oss/env-nextjs:
   ```bash
   npm install @t3-oss/env-nextjs
   ```

2. Create `lib/env.ts` with mode-aware validation:
   - Server vars (required in production, optional in dev when USE_MOCK_DATA=true):
     - DATABASE_URL: z.string().url()
     - NEXTAUTH_SECRET: z.string().min(32) (always required)
     - NEXTAUTH_URL: z.string().url()
     - RESEND_API_KEY: z.string().startsWith("re_")
     - FROM_EMAIL: z.string().email().optional()
     - CLOUDINARY_CLOUD_NAME, CLOUDINARY_API_KEY, CLOUDINARY_API_SECRET (optional)
     - GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, APPLE_CLIENT_ID, APPLE_CLIENT_SECRET (optional - OAuth)
   - Client vars:
     - NEXT_PUBLIC_APP_URL: z.string().url().default("http://localhost:3000")
     - NEXT_PUBLIC_USE_MOCK_DATA: z.enum(["true", "false"]).optional().default("false")
     - NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: z.string().optional()
     - NEXT_PUBLIC_MAPBOX_TOKEN: z.string().optional()
     - NEXT_PUBLIC_DEFAULT_LAT, NEXT_PUBLIC_DEFAULT_LNG, NEXT_PUBLIC_DEFAULT_CITY (optional)

3. Use conditional validation based on NODE_ENV and USE_MOCK_DATA:
   - In production (NODE_ENV=production): DATABASE_URL, RESEND_API_KEY required
   - In mock mode (USE_MOCK_DATA=true): DATABASE_URL, RESEND_API_KEY optional
   - Add skipValidation option for CI environments

4. Update `next.config.js` to import env.ts for build-time validation:
   ```js
   // Validate env at build time
   await import('./lib/env.js');
   ```

Note: The env validation will use Zod v4 (already installed per package.json). Use z.string() patterns, NOT z.string().url() for DATABASE_URL since Prisma connection strings may have special characters.
  </action>
  <verify>
- `npm run build` fails with clear error if NEXTAUTH_SECRET missing
- `npm run dev` works with USE_MOCK_DATA=true even without DATABASE_URL
- TypeScript autocomplete works for `env.DATABASE_URL`
  </verify>
  <done>
- lib/env.ts exports type-safe env object
- Build fails fast with readable error for missing required vars
- Mode-aware: production requires more vars than dev/mock
  </done>
</task>

<task type="auto">
  <name>Task 2: Mock header protection middleware</name>
  <files>middleware.ts</files>
  <action>
1. Create `middleware.ts` at project root with:
   - Check if USE_MOCK_DATA=true (mock mode) - if so, pass through
   - If NOT mock mode and request has x-user-id OR x-user-role headers:
     - Log security warning with IP, path, headers
     - Track attempts per IP in memory Map
     - After 5 attempts in 60 seconds, log "BLOCKED" warning (not actually blocking)
     - Clean up old entries periodically
   - Always call NextResponse.next() - never actually block requests
   - Match only /api/* routes

2. Implementation details:
   - Use Map for in-memory rate tracking (acceptable for logging, resets on cold start)
   - Extract IP from x-forwarded-for (first IP) or x-real-ip
   - Window: 60 seconds, Max attempts: 5, Block log duration: 5 minutes
   - Log format: `[SECURITY] Mock headers in production - IP: {ip}, Path: {path}, Headers: {headers}, Attempt: {n}`

3. IMPORTANT: Do NOT reject requests - security detection must be invisible to attacker. The middleware logs for monitoring but always allows the request to proceed to real auth.
  </action>
  <verify>
- Send request with x-user-id header when USE_MOCK_DATA=false, check server logs for security warning
- Send 5+ requests rapidly, verify "BLOCKED" appears in logs
- Verify actual API response is same as without mock headers (not rejected)
  </verify>
  <done>
- middleware.ts exists at project root
- Logs security warnings for mock headers outside mock mode
- Rate-limits logging to prevent log spam
- Never reveals detection to attacker (always continues request)
  </done>
</task>

</tasks>

<verification>
1. Environment validation:
   - Remove NEXTAUTH_SECRET from .env.local, run `npm run build` - should fail with clear error
   - Restore NEXTAUTH_SECRET, run with USE_MOCK_DATA=true - should work without DATABASE_URL

2. Mock header protection:
   - Start app with USE_MOCK_DATA=false
   - `curl -H "x-user-id: test" http://localhost:3000/api/businesses`
   - Check server logs for security warning
   - Response should be normal (401 or data, depending on auth)
</verification>

<success_criteria>
- SEC-02 satisfied: App fails fast with clear error if required env vars missing in production
- SEC-03 partially satisfied: Mock headers logged when sent outside mock mode (actual rejection handled by existing isMockMode() checks in routes)
- No breaking changes to existing functionality
- Type-safe env access throughout codebase (via env.X instead of process.env.X)
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-fixes/03-01-SUMMARY.md`
</output>
