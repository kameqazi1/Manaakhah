---
phase: 04-missing-email-features
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/email.ts
  - app/api/business/[id]/staff/route.ts
  - lib/auth/two-factor.ts
  - app/api/auth/2fa/setup/route.ts
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Staff invitation sends real email to invited user"
    - "Email includes inviter name, business name, role, and signup/login links"
    - "SMS 2FA option is removed from API validation"
    - "TwoFactorMethod enum no longer includes SMS"
  artifacts:
    - path: "lib/email.ts"
      provides: "sendStaffInvitationEmail function"
      exports: ["sendStaffInvitationEmail"]
    - path: "app/api/business/[id]/staff/route.ts"
      provides: "POST handler that sends invitation email"
      contains: "sendStaffInvitationEmail"
    - path: "prisma/schema.prisma"
      provides: "TwoFactorMethod enum without SMS"
      contains: "enum TwoFactorMethod"
  key_links:
    - from: "app/api/business/[id]/staff/route.ts"
      to: "lib/email.ts"
      via: "sendStaffInvitationEmail call"
      pattern: "sendStaffInvitationEmail"
    - from: "app/api/auth/2fa/setup/route.ts"
      to: "TwoFactorMethod validation"
      via: "method validation array"
      pattern: "AUTHENTICATOR.*EMAIL"
---

<objective>
Implement staff invitation emails and remove unused SMS 2FA option.

Purpose: Complete FEAT-02 (SMS decision: remove) and FEAT-03 (staff invitations). Staff invitations currently create database records but don't notify the invited user. SMS is not shown in UI but API still accepts it - clean this up for consistency.

Output: Staff invitations send real emails; SMS 2FA option fully removed from codebase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-missing-email-features/04-RESEARCH.md
@.planning/phases/04-missing-email-features/04-01-SUMMARY.md

# Key existing files
@lib/email.ts
@app/api/business/[id]/staff/route.ts
@lib/auth/two-factor.ts
@app/api/auth/2fa/setup/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sendStaffInvitationEmail function</name>
  <files>lib/email.ts</files>
  <action>
Add the `sendStaffInvitationEmail` function to lib/email.ts following the existing branded template pattern:

```typescript
export async function sendStaffInvitationEmail(
  email: string,
  inviterName: string,
  businessName: string,
  role: string
): Promise<void> {
  const signUpUrl = `${APP_URL}/signup?invited=true&email=${encodeURIComponent(email)}`;
  const loginUrl = `${APP_URL}/login`;

  // Format role for display (manager -> Manager)
  const displayRole = role.charAt(0).toUpperCase() + role.slice(1);

  await getResend().emails.send({
    from: `${APP_NAME} <${FROM_EMAIL}>`,
    to: email,
    subject: `You've been invited to join ${businessName} on ${APP_NAME}`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f4f4f5; margin: 0; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <div style="background: linear-gradient(135deg, #16a34a 0%, #059669 100%); padding: 40px 20px; text-align: center;">
              <h1 style="color: white; margin: 0; font-size: 28px;">${APP_NAME}</h1>
              <p style="color: rgba(255,255,255,0.9); margin-top: 8px;">You're Invited!</p>
            </div>
            <div style="padding: 40px 30px;">
              <h2 style="color: #111827; margin-top: 0;">Join ${businessName}</h2>
              <p style="color: #4b5563; line-height: 1.6;">
                <strong>${inviterName}</strong> has invited you to join <strong>${businessName}</strong>
                as a <strong>${displayRole}</strong> on ${APP_NAME}.
              </p>
              <div style="background: #f9fafb; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <p style="margin: 0 0 12px 0; color: #374151;"><strong>Business:</strong> ${businessName}</p>
                <p style="margin: 0; color: #374151;"><strong>Your Role:</strong> ${displayRole}</p>
              </div>
              <div style="text-align: center; margin: 30px 0;">
                <a href="${signUpUrl}" style="display: inline-block; background: linear-gradient(135deg, #16a34a 0%, #059669 100%); color: white; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600; font-size: 16px;">
                  Accept Invitation
                </a>
              </div>
              <p style="color: #6b7280; font-size: 14px; text-align: center;">
                Already have an account? <a href="${loginUrl}" style="color: #16a34a; text-decoration: none;">Sign in here</a>
              </p>
              <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
              <p style="color: #9ca3af; font-size: 12px; text-align: center;">
                If you weren't expecting this invitation, you can safely ignore this email.
              </p>
            </div>
          </div>
        </body>
      </html>
    `,
  });
}
```
  </action>
  <verify>
TypeScript compiles. Function is exported from lib/email.ts.
  </verify>
  <done>
`sendStaffInvitationEmail` function added to lib/email.ts with branded HTML template including business name, inviter name, role, and signup/login links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire staff invitation email to staff route</name>
  <files>app/api/business/[id]/staff/route.ts</files>
  <action>
Update the POST handler in `app/api/business/[id]/staff/route.ts` to send the invitation email:

1. Add import at top:
```typescript
import { sendStaffInvitationEmail } from "@/lib/email";
```

2. Replace the TODO comment (around line 265-266) with actual email sending. After the ActivityLog creation and before the return statement (around line 268-281):

```typescript
// Send invitation email
try {
  const inviterName = session.user.name || "A team member";
  await sendStaffInvitationEmail(
    email,
    inviterName,
    business.name,
    role
  );
} catch (emailError) {
  // Log but don't fail the request - invitation record was created
  console.error("Failed to send staff invitation email:", emailError);
}

// Log the activity (existing code)
await prisma.activityLog.create({
  // ... existing code
});
```

Also update the return message to be more accurate:
```typescript
return NextResponse.json({
  success: true,
  staffRole: {
    id: staffRole.id,
    role: staffRole.role,
    permissions: staffRole.permissions,
    user: staffRole.user,
  },
  message: `Invitation email sent to ${email}`,
});
```
  </action>
  <verify>
1. TypeScript compiles
2. Test adding a staff member - verify email is received
3. Check email contains correct business name, role, and links
  </verify>
  <done>
Staff invitation POST handler sends real email via sendStaffInvitationEmail. Email failure is logged but doesn't fail the request (invitation record still created).
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove SMS 2FA option from codebase</name>
  <files>lib/auth/two-factor.ts, app/api/auth/2fa/setup/route.ts, prisma/schema.prisma</files>
  <action>
Clean up SMS 2FA option since it's not implemented and not shown in UI:

**1. Update prisma/schema.prisma:**

Change TwoFactorMethod enum (around line 273-277) from:
```prisma
enum TwoFactorMethod {
  AUTHENTICATOR
  SMS
  EMAIL
}
```

To:
```prisma
enum TwoFactorMethod {
  AUTHENTICATOR
  EMAIL
}
```

Run `npx prisma db push` and `npx prisma generate`.

**2. Update app/api/auth/2fa/setup/route.ts:**

In the POST handler, update the method validation (around line 45):

From:
```typescript
if (!method || !["AUTHENTICATOR", "SMS", "EMAIL"].includes(method)) {
  return NextResponse.json(
    { error: "Invalid 2FA method. Choose AUTHENTICATOR, SMS, or EMAIL" },
    { status: 400 }
  );
}
```

To:
```typescript
if (!method || !["AUTHENTICATOR", "EMAIL"].includes(method)) {
  return NextResponse.json(
    { error: "Invalid 2FA method. Choose AUTHENTICATOR or EMAIL" },
    { status: 400 }
  );
}
```

Remove the SMS branch from the else-if chain (if it exists after the EMAIL handling).

**3. Update lib/auth/two-factor.ts:**

Remove or comment out the `sendTwoFactorSMS` function (around line 121-128):
```typescript
// SMS 2FA removed - not implemented
// export async function sendTwoFactorSMS(phone: string, code: string): Promise<boolean> { ... }
```

Or delete it entirely since it was never wired up.
  </action>
  <verify>
1. `npx prisma db push` completes without errors
2. `npx prisma generate` completes
3. `npm run build` completes without errors
4. API rejects SMS method with "Invalid 2FA method" error
  </verify>
  <done>
- TwoFactorMethod enum only has AUTHENTICATOR and EMAIL
- API validation only accepts AUTHENTICATOR or EMAIL
- sendTwoFactorSMS function removed from two-factor.ts
- Codebase is consistent: SMS not in UI, not in API, not in types
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build`
2. Staff invitation flow:
   - Invite staff member via API or UI
   - Verify email is received
   - Email shows correct business name, inviter, role
   - Links work (signup and login)
3. SMS removal verified:
   - POST /api/auth/2fa/setup with method: "SMS" returns 400 error
   - TwoFactorMethod type only shows AUTHENTICATOR | EMAIL
</verification>

<success_criteria>
- FEAT-02 complete: SMS option removed (decision: not implementing)
- FEAT-03 complete: Staff invitations send real emails
- Email includes inviter name, business name, role, signup link, login link
- Codebase is clean: no SMS references in 2FA code paths
- All TypeScript compiles, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-missing-email-features/04-02-SUMMARY.md`
</output>
