// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CONSUMER
  BUSINESS_OWNER
  ADMIN
}

enum BusinessStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
}

enum BusinessCategory {
  HALAL_FOOD
  RESTAURANT
  GROCERY
  MASJID
  AUTO_REPAIR
  PLUMBING
  ELECTRICAL
  HANDYMAN
  TUTORING
  LEGAL_SERVICES
  ACCOUNTING
  HEALTH_WELLNESS
  BARBER_SALON
  CHILDCARE
  COMMUNITY_AID
  OTHER
}

enum BusinessTag {
  MUSLIM_OWNED
  HALAL_VERIFIED
  SISTERS_FRIENDLY
  KID_FRIENDLY
  WHEELCHAIR_ACCESSIBLE
  PRAYER_SPACE
}

enum VerificationType {
  HALAL
  MUSLIM_OWNED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  NOT_REQUIRED
  PENDING
  PAID
  REFUNDED
}

enum ConversationStatus {
  OPEN
  RESOLVED
  CLOSED
  ARCHIVED
}

enum PostType {
  ANNOUNCEMENT
  EVENT
  RESOURCE
  QUESTION
  DISCUSSION
  PROMOTION
}

enum PostStatus {
  DRAFT
  PUBLISHED
  FLAGGED
  HIDDEN
  DELETED
}

enum CommentStatus {
  PUBLISHED
  HIDDEN
  DELETED
}

enum ReviewStatus {
  PUBLISHED
  PENDING
  FLAGGED
  HIDDEN
  DELETED
}

enum ReportReason {
  SPAM
  FAKE
  OFFENSIVE
  IRRELEVANT
  COMPETITOR
  OTHER
}

enum ReportStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum ViewSource {
  MAP
  SEARCH
  PROFILE
  RECOMMENDATION
  COMMUNITY
}

enum PriceRange {
  BUDGET
  MODERATE
  PREMIUM
  LUXURY
}

enum ClaimStatus {
  UNCLAIMED
  CLAIMED
  DISPUTED
}

enum ScrapedBusinessClaimStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  phone         String?
  password      String
  role          UserRole  @default(CONSUMER)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Email verification
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Password reset
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?

  businesses           Business[]
  reviews              Review[]
  sentMessages         Message[]             @relation("SentMessages")
  conversations        Conversation[]        @relation("CustomerConversations")
  accounts             Account[]
  sessions             Session[]
  customerBookings     Booking[]             @relation("CustomerBookings")
  postLikes            PostLike[]
  posts                CommunityPost[]
  postComments         PostComment[]
  commentLikes         CommentLike[]
  reviewReports        ReviewReport[]        @relation("ReportedReviews")
  resolvedReports      ReviewReport[]        @relation("ResolvedReports")
  reviewHelpful        ReviewHelpful[]
  businessViews        BusinessView[]
  notifications        Notification[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Business {
  id          String           @id @default(cuid())
  ownerId     String
  name        String
  slug        String           @unique
  description String           @db.Text
  shortDescription String?     @db.VarChar(200)
  category    BusinessCategory
  address     String
  city        String
  state       String           @default("CA")
  zipCode     String
  latitude    Float
  longitude   Float
  phone       String
  email       String?
  website     String?
  hours       Json? // {monday: {open: "09:00", close: "17:00"}, ...}
  services    String[] // Array of services offered
  status      BusinessStatus   @default(DRAFT)

  // New fields for enhanced features
  priceRange           PriceRange?
  hoursOfOperation     Json?
  verificationStatus   VerificationStatus @default(PENDING)
  verifiedAt           DateTime?
  verifiedBy           String?
  viewCount            Int      @default(0)
  claimStatus          ClaimStatus @default(UNCLAIMED)
  coverImage           String?
  logoImage            String?
  scrapedFrom          String?
  scrapedAt            DateTime?
  confidenceScore      Int?
  averageRating        Float?   @default(0)
  totalReviews         Int      @default(0)
  ratingBreakdown      Json?
  isScraped            Boolean  @default(false)
  scrapedBusinessId    String?  @unique

  // Masjid specific fields
  prayerTimes Json? // {fajr: "05:30", dhuhr: "13:00", ...}
  jummahTime  String?

  // Aid organization specific
  aidServices String[] // Services for community aid orgs
  externalUrl String?  // External application URL

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  owner                User                     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  photos               BusinessPhoto[]
  tags                 BusinessTagRelation[]
  reviews              Review[]
  conversations        Conversation[]
  events               Event[]
  bookings             Booking[]
  posts                CommunityPost[]
  businessViews        BusinessView[]
  availability         BusinessAvailability[]
  availabilityExceptions AvailabilityException[]
  deals                Deal[]
  verificationRequests VerificationRequest[]

  @@index([ownerId])
  @@index([slug])
  @@index([category])
  @@index([latitude, longitude])
  @@index([status])
  @@index([city, category])
  @@index([status, verificationStatus])
}

model BusinessPhoto {
  id         String   @id @default(cuid())
  businessId String
  url        String
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model BusinessTagRelation {
  id         String      @id @default(cuid())
  businessId String
  tag        BusinessTag

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, tag])
  @@index([businessId])
  @@index([tag])
}

model Review {
  id         String   @id @default(cuid())
  businessId String
  userId     String
  bookingId  String?
  rating     Int // 1-5
  title      String?  @db.VarChar(100)
  content    String   @db.Text
  text       String?  @db.Text
  photos     String[]
  tags       Json? // {serviceQuality: true, cleanliness: true, familyFriendly: true}

  isVerified   Boolean  @default(false)
  verifiedAt   DateTime?
  helpfulCount Int      @default(0)
  reportCount  Int      @default(0)

  ownerResponse String?   @db.Text
  respondedAt   DateTime?

  status      ReviewStatus @default(PUBLISHED)
  flagReason  String?
  moderatedBy String?
  moderatedAt DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business      Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking       Booking?         @relation(fields: [bookingId], references: [id])
  reviewPhotos  ReviewPhoto[]
  flags         ReviewFlag[]
  helpfulVotes  ReviewHelpful[]
  reports       ReviewReport[]

  @@unique([businessId, userId, bookingId])
  @@index([businessId])
  @@index([userId])
  @@index([rating])
  @@index([businessId, status])
}

model ReviewPhoto {
  id       String @id @default(cuid())
  reviewId String
  url      String

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

model ReviewFlag {
  id        String   @id @default(cuid())
  reviewId  String
  reason    String
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
}

model ReviewHelpful {
  id        String   @id @default(cuid())
  reviewId  String
  userId    String
  createdAt DateTime @default(now())

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
}

model ReviewReport {
  id          String       @id @default(cuid())
  reviewId    String
  reportedBy  String
  reason      ReportReason
  details     String?      @db.Text
  status      ReportStatus @default(PENDING)
  resolvedBy  String?
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())

  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporter User   @relation("ReportedReviews", fields: [reportedBy], references: [id])
  resolver User?  @relation("ResolvedReports", fields: [resolvedBy], references: [id])

  @@index([reviewId])
  @@index([status])
}

model Conversation {
  id         String             @id @default(cuid())
  businessId String
  customerId String
  subject    String?            @db.VarChar(200)
  status     ConversationStatus @default(OPEN)
  lastMessageAt DateTime        @default(now())

  unreadByCustomer Int     @default(0)
  unreadByBusiness Int     @default(0)

  isBlocked     Boolean @default(false)
  blockedBy     String?
  blockedReason String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer User     @relation("CustomerConversations", fields: [customerId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([businessId, customerId])
  @@index([businessId])
  @@index([customerId])
  @@index([businessId, status, lastMessageAt])
}

model Message {
  id             String    @id @default(cuid())
  conversationId String
  senderId       String
  content        String    @db.Text
  text           String?   @db.Text
  attachments    String[]
  read           Boolean   @default(false)
  readAt         DateTime?
  editedAt       DateTime?
  deletedAt      DateTime?
  isFlagged      Boolean   @default(false)
  flagReason     String?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([conversationId, createdAt])
}

model VerificationRequest {
  id          String             @id @default(cuid())
  businessId  String
  type        VerificationType
  documentUrl String
  status      VerificationStatus @default(PENDING)
  reviewedBy  String?
  reviewNote  String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
}

model Event {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String   @db.Text
  startTime   DateTime
  endTime     DateTime
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([startTime])
}

model Booking {
  id              String        @id @default(cuid())
  businessId      String
  customerId      String
  serviceType     String
  appointmentDate DateTime
  appointmentTime String
  duration        Int
  notes           String?       @db.Text

  status          BookingStatus @default(PENDING)
  statusHistory   Json[]

  ownerNotes      String?       @db.Text
  rejectionReason String?

  reminderSent    Boolean       @default(false)
  reminderSentAt  DateTime?

  price           Float?
  paymentStatus   PaymentStatus @default(NOT_REQUIRED)
  paymentId       String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  confirmedAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer User     @relation("CustomerBookings", fields: [customerId], references: [id])
  review   Review?

  @@index([businessId, appointmentDate])
  @@index([customerId])
  @@index([status])
}

model BusinessAvailability {
  id           String  @id @default(cuid())
  businessId   String
  dayOfWeek    Int
  startTime    String
  endTime      String
  slotDuration Int
  isAvailable  Boolean @default(true)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek])
  @@index([businessId])
}

model AvailabilityException {
  id          String   @id @default(cuid())
  businessId  String
  date        DateTime @db.Date
  isAvailable Boolean
  startTime   String?
  endTime     String?
  reason      String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, date])
  @@index([businessId])
}

model CommunityPost {
  id          String     @id @default(cuid())
  authorId    String
  businessId  String?
  title       String     @db.VarChar(200)
  content     String     @db.Text
  postType    PostType
  media       String[]
  tags        String[]

  viewCount    Int @default(0)
  likeCount    Int @default(0)
  commentCount Int @default(0)
  shareCount   Int @default(0)

  status      PostStatus @default(PUBLISHED)
  isPinned    Boolean    @default(false)
  flagCount   Int        @default(0)

  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author   User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  business Business?      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  likes    PostLike[]
  comments PostComment[]
  reports  PostReport[]

  @@index([status, publishedAt])
  @@index([authorId])
  @@index([businessId])
  @@index([postType])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
}

model PostComment {
  id        String        @id @default(cuid())
  postId    String
  userId    String
  parentId  String?
  content   String        @db.Text
  likeCount Int           @default(0)
  status    CommentStatus @default(PUBLISHED)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  post    CommunityPost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  PostComment?   @relation("CommentReplies", fields: [parentId], references: [id])
  replies PostComment[]  @relation("CommentReplies")
  likes   CommentLike[]

  @@index([postId, createdAt])
  @@index([userId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment PostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
}

model PostReport {
  id         String   @id @default(cuid())
  postId     String
  reportedBy String
  reason     String
  details    String?
  status     ReportStatus @default(PENDING)
  createdAt  DateTime @default(now())

  post     CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter User          @relation(fields: [reportedBy], references: [id])

  @@index([postId])
  @@index([status])
}

model BusinessView {
  id         String     @id @default(cuid())
  businessId String
  userId     String?
  source     ViewSource
  latitude   Float?
  longitude  Float?
  createdAt  DateTime   @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id])

  @@index([businessId, source])
  @@index([createdAt])
}

model ScrapedBusiness {
  id          String                     @id @default(cuid())
  name        String
  address     String
  city        String
  state       String
  zipCode     String
  latitude    Float?
  longitude   Float?
  phone       String?
  email       String?
  website     String?
  category    BusinessCategory
  description String?                    @db.Text
  sourceUrl   String
  scrapedAt   DateTime                   @default(now())
  claimStatus ScrapedBusinessClaimStatus @default(PENDING_REVIEW)
  reviewedAt  DateTime?
  metadata    Json? // Stores scraper metadata like confidence, source, etc.

  @@index([claimStatus])
  @@index([scrapedAt])
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  NEW_MESSAGE
  NEW_REVIEW
  REVIEW_RESPONSE
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  DEAL_EXPIRING
  SYSTEM_ANNOUNCEMENT
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  read      Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

enum DealType {
  PERCENTAGE_OFF
  FIXED_AMOUNT_OFF
  BUY_ONE_GET_ONE
  SPECIAL_PRICE
  FREE_ITEM
}

model Deal {
  id              String    @id @default(cuid())
  businessId      String
  title           String
  description     String    @db.Text
  dealType        DealType
  value           Float
  originalPrice   Float?
  specialPrice    Float?
  conditions      String?   @db.Text
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean   @default(true)
  maxRedemptions  Int?
  currentRedemptions Int    @default(0)
  code            String?
  imageUrl        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId, isActive])
  @@index([endDate])
}
